<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | SDÃœ Oryantiring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-success { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }
        .btn-warning { background: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.2); }
        .btn-info { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.2); }
        .penalty-btn { font-size: 8px; font-weight: 800; padding: 4px 6px; border-radius: 6px; transition: all 0.2s; }
        .penalty-btn:hover { transform: translateY(-2px); filter: brightness(1.2); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #9b1c31; border-radius: 10px; }
        
        #teamModal { transition: opacity 0.3s ease; }
        .modal-content { max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="notifArea" class="fixed top-5 left-1/2 -translate-x-1/2 z-[500] w-full max-w-sm"></div>

    <!-- TAKIM DETAY MODAL -->
    <div id="teamModal" class="fixed inset-0 z-[600] flex items-center justify-center bg-black/80 backdrop-blur-sm opacity-0 pointer-events-none p-4">
        <div class="glass w-full max-w-2xl rounded-[2rem] p-8 relative shadow-3xl border-t-4 border-red-700">
            <button onclick="closeModal()" class="absolute top-6 right-6 p-2 glass rounded-full hover:text-red-500 transition-colors">
                <i data-lucide="x"></i>
            </button>
            <div id="modalBody"></div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 mb-10 text-center md:text-left">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-red-700 rounded-2xl shadow-xl shadow-red-900/20"><i data-lucide="shield-check" class="text-white"></i></div>
                <div>
                    <h1 class="text-2xl font-black uppercase">SDÃœ <span class="text-red-600">ADMÄ°N</span></h1>
                    <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest text-left">GeliÅŸmiÅŸ TakÄ±m ve SÃ¼re YÃ¶netimi</p>
                </div>
            </div>
            <button onclick="fetchTeams()" class="px-6 py-3 glass rounded-xl hover:bg-white/5 transition-all flex items-center gap-2 text-white font-bold uppercase text-xs">
                <i data-lucide="refresh-cw" id="refresh-icon"></i> Verileri Yenile
            </button>
        </header>

        <div class="glass rounded-[2rem] overflow-hidden shadow-2xl">
            <table class="w-full text-left border-collapse">
                <thead class="bg-white/5 text-[10px] font-black uppercase tracking-widest text-slate-400">
                    <tr>
                        <th class="px-6 py-5">TakÄ±m AdÄ± (Bilgi Ä°Ã§in TÄ±kla)</th>
                        <th class="px-6 py-5">GiriÅŸ Kodu</th>
                        <th class="px-6 py-5">SÃ¼re / Kontrol</th>
                        <th class="px-6 py-5">Ceza (+/- DK)</th>
                        <th class="px-6 py-5 text-right">Ä°ÅŸlem</th>
                    </tr>
                </thead>
                <tbody id="teamsBody" class="divide-y divide-white/5 text-sm">
                    <tr><td colspan="5" class="p-20 text-center text-slate-500 italic">Veriler senkronize ediliyor...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://hxdmiamcednlzoklkxnu.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2lmWYp5Pkvn_BsADVHPKug_KK9n8v2-';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let teamsData = [];

        function toast(msg, isErr = false) {
            const div = document.createElement('div');
            div.className = `p-4 rounded-xl mb-2 text-xs font-bold uppercase tracking-widest shadow-2xl backdrop-blur-md border animate-bounce ${isErr ? 'bg-red-500/20 text-red-500 border-red-500/50' : 'bg-emerald-500/20 text-emerald-500 border-emerald-500/50'}`;
            div.innerText = msg;
            document.getElementById('notifArea').appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        async function fetchTeams() {
            const icon = document.getElementById('refresh-icon');
            icon?.classList.add('animate-spin');
            const { data, error } = await supabaseClient.from('registrations').select('*').order('created_at', { ascending: false });
            if (!error) { 
                teamsData = data; 
                render(); 
            } else {
                toast(error.message, true);
            }
            icon?.classList.remove('animate-spin');
        }

        function format(s) {
            const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        function getElapsed(t) {
            if (!t.is_timer_running) return Number(t.elapsed_seconds || 0);
            if (!t.timer_started_at) return Number(t.elapsed_seconds || 0);
            const now = Date.now();
            const start = new Date(t.timer_started_at).getTime();
            return Math.floor((now - start) / 1000) + Number(t.elapsed_seconds || 0);
        }

        function openModal(teamId) {
            const t = teamsData.find(x => x.id === teamId);
            if (!t) return;
            const modal = document.getElementById('teamModal');
            const body = document.getElementById('modalBody');
            
            let membersHtml = t.members.map((m, i) => `
                <div class="p-4 rounded-2xl bg-white/5 border border-white/5 space-y-2 mb-3">
                    <div class="flex items-center gap-2">
                        <span class="font-bold uppercase text-sm text-red-500">${i === 0 ? 'ðŸ‘‘ LÄ°DER:' : (i + 1) + '. ÃœYE:'} ${m.name}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-y-2 text-[10px] uppercase font-bold text-slate-400">
                        <div class="flex items-center gap-1"><i data-lucide="mail" class="w-3 h-3"></i> ${m.email}</div>
                        <div class="flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${m.phone}</div>
                        <div class="flex items-center gap-1"><i data-lucide="graduation-cap" class="w-3 h-3"></i> ${m.dept}</div>
                        <div class="flex items-center gap-1"><i data-lucide="hash" class="w-3 h-3"></i> ${m.class}</div>
                    </div>
                </div>
            `).join('');

            body.innerHTML = `
                <h2 class="text-2xl font-black uppercase text-white mb-1">${t.team_name}</h2>
                <p class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em] mb-6">BaÅŸvuru DetaylarÄ±</p>
                <div class="modal-content pr-2">${membersHtml}</div>
            `;
            modal.classList.remove('opacity-0', 'pointer-events-none');
            lucide.createIcons();
        }

        function closeModal() { document.getElementById('teamModal').classList.add('opacity-0', 'pointer-events-none'); }

        function render() {
            const body = document.getElementById('teamsBody');
            if (teamsData.length === 0) { body.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-slate-500">HenÃ¼z kayÄ±t yok.</td></tr>'; return; }

            body.innerHTML = teamsData.map(t => `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4">
                        <button onclick="openModal('${t.id}')" class="font-bold uppercase text-white hover:text-red-500 transition-colors underline decoration-red-700/50 underline-offset-4 text-left">
                            ${t.team_name}
                        </button>
                        <div class="text-[9px] text-slate-600 font-bold uppercase mt-1 tracking-widest">${t.members?.length || 0} YARIÅžMACI</div>
                    </td>
                    <td class="px-6 py-4">
                        <input type="text" value="${t.team_code || ''}" placeholder="KOD ATA" onchange="updateTeamCode('${t.id}', this.value)"
                            class="bg-black/40 border border-white/10 rounded-lg px-3 py-1.5 text-xs font-mono text-red-500 w-24 uppercase outline-none focus:border-red-600">
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="flex gap-1">
                                ${!t.is_timer_running ? 
                                    `<button onclick="handleTimer('${t.id}', 'start')" class="p-2 btn-success rounded-lg hover:scale-110"><i data-lucide="play" class="w-4 h-4"></i></button>` :
                                    `<button onclick="handleTimer('${t.id}', 'stop')" class="p-2 btn-danger rounded-lg hover:scale-110"><i data-lucide="pause" class="w-4 h-4"></i></button>`
                                }
                                <button onclick="handleTimer('${t.id}', 'reset')" class="p-2 bg-slate-800 text-slate-400 rounded-lg hover:text-white transition-all"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                            </div>
                            <div>
                                <div class="text-sm font-black mono text-white leading-none" id="t-${t.id}">${format(getElapsed(t))}</div>
                                <span class="text-[8px] font-bold uppercase ${t.is_timer_running ? 'text-emerald-500 animate-pulse' : 'text-slate-600'}">
                                    ${t.is_timer_running ? 'KoÅŸuyor' : 'HazÄ±r'}
                                </span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="grid grid-cols-2 gap-2 w-32">
                            <div class="flex flex-col gap-1">
                                <button onclick="adjPen('${t.id}', 5)" class="penalty-btn btn-warning">+5 DK</button>
                                <button onclick="adjPen('${t.id}', 15)" class="penalty-btn btn-warning">+15 DK</button>
                                <button onclick="adjPen('${t.id}', 25)" class="penalty-btn btn-warning">+25 DK</button>
                            </div>
                            <div class="flex flex-col gap-1">
                                <button onclick="adjPen('${t.id}', -5)" class="penalty-btn btn-info">-5 DK</button>
                                <button onclick="adjPen('${t.id}', -15)" class="penalty-btn btn-info">-15 DK</button>
                                <button onclick="adjPen('${t.id}', -25)" class="penalty-btn btn-info">-25 DK</button>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="delTeam('${t.id}')" class="p-2 text-slate-700 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        setInterval(() => {
            teamsData.forEach(t => {
                if(t.is_timer_running) {
                    const el = document.getElementById(`t-${t.id}`);
                    if(el) el.innerText = format(getElapsed(t));
                }
            });
        }, 1000);

        async function updateTeamCode(id, code) {
            await supabaseClient.from('registrations').update({ team_code: code.trim().toUpperCase() }).eq('id', id);
            toast("GiriÅŸ Kodu GÃ¼ncellendi");
        }

        async function handleTimer(id, action) {
            const teamIndex = teamsData.findIndex(x => x.id === id);
            const t = teamsData[teamIndex];
            let up = {};

            if(action === 'start') {
                up = { is_timer_running: true, timer_started_at: new Date().toISOString() };
            } else if(action === 'stop') {
                up = { is_timer_running: false, elapsed_seconds: getElapsed(t) };
            } else if(action === 'reset') {
                if(!confirm('Bu takÄ±mÄ±n tÃ¼m sÃ¼resini ve cezalarÄ±nÄ± sÄ±fÄ±rlamak istiyor musunuz?')) return;
                up = { is_timer_running: false, elapsed_seconds: 0, timer_started_at: null };
                
                // UI'Ä± anÄ±nda gÃ¼ncelle (Supabase cevabÄ± gelmeden Ã¶nce)
                const timerEl = document.getElementById(`t-${id}`);
                if(timerEl) timerEl.innerText = "00:00:00";
            }

            const { error } = await supabaseClient.from('registrations').update(up).eq('id', id);
            
            if (!error) { 
                toast(action.toUpperCase() + " Ä°ÅžLEMÄ° BAÅžARILI"); 
                fetchTeams(); 
            } else {
                toast("Hata: " + error.message, true);
            }
        }

        async function adjPen(id, mins) {
            const teamIndex = teamsData.findIndex(x => x.id === id);
            const t = teamsData[teamIndex];
            const currentSeconds = getElapsed(t); // Mevcut anlÄ±k sÃ¼reyi al
            
            // EÄŸer sayaÃ§ Ã§alÄ±ÅŸÄ±yorsa, aradaki farkÄ± elapsed'a ekle ve timer_started_at'i ÅŸimdiye Ã§ek (drift Ã¶nleme)
            let up = {};
            const penaltySeconds = mins * 60;
            const newTotal = Math.max(0, currentSeconds + penaltySeconds);
            
            if (t.is_timer_running) {
                up = { 
                    elapsed_seconds: newTotal,
                    timer_started_at: new Date().toISOString()
                };
            } else {
                up = { elapsed_seconds: newTotal };
            }

            const { error } = await supabaseClient.from('registrations').update(up).eq('id', id);
            if (!error) {
                toast((mins > 0 ? "+" : "") + mins + " DK GÃœNCELLENDÄ°");
                fetchTeams();
            }
        }

        async function delTeam(id) { if(confirm('TakÄ±mÄ± tamamen silmek istediÄŸinize emin misiniz?')) { await supabaseClient.from('registrations').delete().eq('id', id); fetchTeams(); } }

        window.onload = () => { 
            fetchTeams(); 
            supabaseClient.channel('live_admin_view').on('postgres_changes', { event:'*', schema:'public', table:'registrations' }, () => fetchTeams()).subscribe(); 
        };
        lucide.createIcons();
    </script>
</body>
</html>
